@model List<TalentoPlus.Core.DTOs.EmployeeResponseDto>
@{
    ViewData["Title"] = "Gestión de Empleados";
}

<div class="container mt-4">
    <h2>Gestión de Empleados</h2>
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#createModal">
        <i class="bi bi-plus-circle"></i> Nuevo Empleado
    </button>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Documento</th>
                    <th>Email</th>
                    <th>Departamento</th>
                    <th>Puesto</th>
                    <th>Salario</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="employeesTable">
                @if (Model?.Any() == true)
                {
                    @foreach (var e in Model)
                    {
                        <tr id="row-@e.Id">
                            <td>@e.Id</td>
                            <td>@e.FirstName @e.LastName</td>
                            <td>@e.Document</td>
                            <td>@e.Email</td>
                            <td>@e.DepartmentName</td>
                            <td>@e.PositionName</td>
                            <td>@e.Salary.ToString("C")</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="openEmployeeModal(@e.Id, 'view')" title="Ver"><i class="bi bi-eye"></i></button>
                                <button class="btn btn-sm btn-warning" onclick="openEmployeeModal(@e.Id, 'edit')" title="Editar"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="prepareDelete(@e.Id, '@e.FirstName @e.LastName', '@e.Email')" title="Eliminar"><i class="bi bi-trash"></i></button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr id="noEmployeesRow">
                        <td colspan="8" class="text-center">No hay empleados registrados</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modales Crear / Editar / Ver / Eliminar permanecen igual que en la versión anterior -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<script>
const createForm = document.getElementById('createForm');
const editForm = document.getElementById('editForm');
let employeeToDelete = null;

async function fetchJson(url, options = {}) {
    try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
    } catch(e) { console.error(e); alert('Ocurrió un error'); }
}

function fillForm(form, data) {
    for (const key in data) {
        const input = form.querySelector(`[name="${key}"]`);
        if (input) input.value = data[key] ?? '';
    }
}

function renderEmployeeRow(employee) {
    const tr = document.createElement('tr');
    tr.id = `row-${employee.id}`;
    tr.innerHTML = `
        <td>${employee.id}</td>
        <td>${employee.firstName} ${employee.lastName}</td>
        <td>${employee.document}</td>
        <td>${employee.email}</td>
        <td>${employee.departmentName || ''}</td>
        <td>${employee.positionName || ''}</td>
        <td>${employee.salary?.toLocaleString('en-US',{style:'currency',currency:'USD'}) || '$0'}</td>
        <td>
            <button class="btn btn-sm btn-info" onclick="openEmployeeModal(${employee.id}, 'view')" title="Ver"><i class="bi bi-eye"></i></button>
            <button class="btn btn-sm btn-warning" onclick="openEmployeeModal(${employee.id}, 'edit')" title="Editar"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-danger" onclick="prepareDelete(${employee.id}, '${employee.firstName} ${employee.lastName}', '${employee.email}')" title="Eliminar"><i class="bi bi-trash"></i></button>
        </td>`;
    return tr;
}

async function openEmployeeModal(id, mode) {
    const employee = await fetchJson(`/api/Employees/${id}`);
    if (!employee) return;

    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    const body = document.querySelector('#editModal .modal-body');
    const footer = document.querySelector('#editModal .modal-footer');

    if (mode === 'view') {
        body.innerHTML = `
        <dl class="row">
            <dt class="col-sm-3">ID:</dt><dd class="col-sm-9">${employee.id}</dd>
            <dt class="col-sm-3">Nombre:</dt><dd class="col-sm-9">${employee.firstName} ${employee.lastName}</dd>
            <dt class="col-sm-3">Documento:</dt><dd class="col-sm-9">${employee.document}</dd>
            <dt class="col-sm-3">Email:</dt><dd class="col-sm-9">${employee.email}</dd>
            <dt class="col-sm-3">Teléfono:</dt><dd class="col-sm-9">${employee.phone || 'No registrado'}</dd>
            <dt class="col-sm-3">Departamento:</dt><dd class="col-sm-9">${employee.departmentName || 'No asignado'}</dd>
            <dt class="col-sm-3">Puesto:</dt><dd class="col-sm-9">${employee.positionName || 'No asignado'}</dd>
            <dt class="col-sm-3">Salario:</dt><dd class="col-sm-9">$${employee.salary?.toLocaleString() || '0'}</dd>
        </dl>`;
        document.querySelector('#editModal .modal-title').textContent = 'Ver Empleado';
        footer.style.display = 'none';
    } else {
        document.getElementById('editId').value = employee.id;
        body.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3"><label class="form-label">Nombre</label><input type="text" class="form-control" name="FirstName" required></div>
                <div class="mb-3"><label class="form-label">Apellido</label><input type="text" class="form-control" name="LastName" required></div>
                <div class="mb-3"><label class="form-label">Teléfono</label><input type="text" class="form-control" name="Phone"></div>
            </div>
            <div class="col-md-6">
                <div class="mb-3"><label class="form-label">Dirección</label><input type="text" class="form-control" name="Address"></div>
                <div class="mb-3"><label class="form-label">Salario</label><input type="number" step="0.01" class="form-control" name="Salary"></div>
                <div class="mb-3"><label class="form-label">Perfil Profesional</label><textarea class="form-control" name="ProfessionalProfile" rows="2"></textarea></div>
            </div>
        </div>`;
        fillForm(editForm, employee);
        document.querySelector('#editModal .modal-title').textContent = 'Editar Empleado';
        footer.style.display = 'flex';
    }
    modal.show();
}

async function submitForm(form, url, method='POST') {
    const data = Object.fromEntries(new FormData(form).entries());
    ['PositionId','DepartmentId','EmployeeStatusId','EducationLevelId'].forEach(k=>data[k]=1);
    data.Salary = parseFloat(data.Salary)||0;
    data.BirthDate = data.BirthDate || new Date().toISOString();
    data.HireDate = data.HireDate || new Date().toISOString();

    try {
        const res = await fetch(url, {method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
        if(res.ok){
            const employee = await res.json();
            const tr = renderEmployeeRow(employee);
            if(method==='POST'){
                const noRow = document.getElementById('noEmployeesRow');
                if(noRow) noRow.remove();
                document.getElementById('employeesTable').appendChild(tr);
                bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
                form.reset();
            } else {
                const oldRow = document.getElementById(`row-${employee.id}`);
                oldRow.replaceWith(tr);
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            }
        } else alert('Error al procesar empleado');
    } catch(e){console.error(e);alert('Error al procesar empleado');}
}

createForm?.addEventListener('submit', e=>{e.preventDefault(); submitForm(createForm,'/api/Employees');});
editForm?.addEventListener('submit', e=>{
    e.preventDefault();
    const id = document.getElementById('editId').value;
    submitForm(editForm, `/api/Employees/${id}`, 'PUT');
});

function prepareDelete(id,name,email){
    employeeToDelete=id;
    document.getElementById('deleteEmployeeName').textContent=`${name} (${email})`;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

async function confirmDelete(){
    if(!employeeToDelete) return;
    try{
        const res = await fetch(`/api/Employees/${employeeToDelete}`, {method:'DELETE'});
        if(res.ok){
            document.getElementById(`row-${employeeToDelete}`).remove();
            const table = document.getElementById('employeesTable');
            if(table.children.length===0){
                const tr = document.createElement('tr');
                tr.id='noEmployeesRow';
                tr.innerHTML=`<td colspan="8" class="text-center">No hay empleados registrados</td>`;
                table.appendChild(tr);
            }
            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            employeeToDelete=null;
        } else alert('Error al eliminar empleado');
    } catch(e){console.error(e);alert('Error al eliminar empleado');}
}

// Hacer funciones globales
window.openEmployeeModal = openEmployeeModal;
window.prepareDelete = prepareDelete;
window.confirmDelete = confirmDelete;
</script>
